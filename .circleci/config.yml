webhook-created: &webhook-created
  name: Webhook created
  command: |
    curl $WEBHOOK_BUILD_URL\?flow\=circleci-created -d '{"repository":"'"$CIRCLE_PROJECT_REPONAME"'","branch":"'"$CIRCLE_BRANCH"'","build_number":"'"$CIRCLE_BUILD_NUM"'","build_url":"'"$CIRCLE_BUILD_URL"'"}' -H "Content-Type: application/json" -X POST -i || true
webhook-failed: &webhook-failed
  name: Webhook completed
  when: on_fail
  command: |
    curl $WEBHOOK_BUILD_URL\?flow\=circleci-completed\&status\=FAILED -d '{"repository":"'"$CIRCLE_PROJECT_REPONAME"'","branch":"'"$CIRCLE_BRANCH"'","build_number":"'"$CIRCLE_BUILD_NUM"'","build_url":"'"$CIRCLE_BUILD_URL"'"}' -H "Content-Type: application/json" -X POST -i || true
prepare-image: &prepare-image
  name: Prepare image
  command: apt-get update && apt-get install -y openjdk-8-jdk

version: 2
jobs:
  webhook-completed:
    docker:
      - image: curlimages/curl:7.70.0
    steps:
      - run:
          name: Webhook completed
          command: |
            curl $WEBHOOK_BUILD_URL\?flow\=circleci-completed -d '{"repository":"'"$CIRCLE_PROJECT_REPONAME"'","branch":"'"${CIRCLE_BRANCH:-${CIRCLE_TAG/-/\/}}"'","build_number":"'"$CIRCLE_PREVIOUS_BUILD_NUM"'","build_url":"'"$CIRCLE_BUILD_URL"'"}' -H "Content-Type: application/json" -X POST -i || true
  build:
    docker:
      - image: circleci/openjdk:8-jdk-browsers
    environment:
      GRADLE_OPTS: '-Xmx128m -Dorg.gradle.daemon=false -Dorg.gradle.jvmargs="-Xmx1024m"'
    steps:
      - run:
          <<: *webhook-created
      - checkout
      - run: chmod a+x gradlew
      - run:
          name: Build all projects
          command: ./gradlew clean build publish -x bintrayUpload --stacktrace
      - run:
          <<: *webhook-failed

  release-candidate:
    docker:
      - image: circleci/openjdk:8-jdk-browsers
    environment:
      GRADLE_OPTS: '-Xmx128m -Dorg.gradle.daemon=false -Dorg.gradle.jvmargs="-Xmx1024m"'
    steps:
      - run:
          <<: *webhook-created
      - add_ssh_keys:
          fingerprints:
            - "dc:17:c5:39:f0:6a:ac:48:bf:21:d4:82:7c:28:95:b2"
      - checkout
      - run: git config --local user.email "ci@leftshift.one" && git config --local user.name "Continuous Integration"
      - run: chmod a+x gradlew
      - run: ./gradlew build --stacktrace
      - run: ./gradlew candidate publish -Prelease.useLastTag=true --stacktrace
      - run:
          <<: *webhook-failed

  release:
    docker:
      - image: python:3.7-stretch
    environment:
      GRADLE_OPTS: '-Xmx128m -Dorg.gradle.daemon=false -Dorg.gradle.jvmargs="-Xmx1024m"'
    steps:
      - run:
          <<: *webhook-created
      - run:
          <<: *prepare-image
      - add_ssh_keys:
          fingerprints:
            - "dc:17:c5:39:f0:6a:ac:48:bf:21:d4:82:7c:28:95:b2"
      - checkout
      - run: git config --local user.email "ci@leftshift.one" && git config --local user.name "Continuous Integration"
      - run: chmod a+x gradlew
      - run: ./gradlew build --stacktrace
      - run: ./gradlew final publish -Prelease.useLastTag=true --stacktrace
      - run:
          <<: *webhook-failed

workflows:
  version: 2
  build:
    jobs:
      - build:
          context: asteria
          filters:
            tags:
              ignore: /.*/
      - webhook-completed:
          context: asteria
          filters:
            tags:
              ignore: /.*/
          requires:
            - build
  weeklyBuild:
    triggers:
      - schedule:
          cron: "30 0 * * 0"
          filters:
            branches:
              only:
                - master
    jobs:
      - build:
          context: asteria
      - webhook-completed:
          context: asteria
          requires:
            - build
  release-candidate:
    jobs:
      - release-candidate:
          context: asteria
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v\d+\.\d+\.\d+-rc\.\d+$/
      - webhook-completed:
          context: asteria
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v\d+\.\d+\.\d+-rc\.\d+$/
          requires:
            - release-candidate
  release:
    jobs:
      - release:
          context: asteria
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v\d+\.\d+\.\d+$/
      - webhook-completed:
          context: asteria
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v\d+\.\d+\.\d+$/
          requires:
            - release
